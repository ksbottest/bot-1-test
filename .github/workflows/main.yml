name: Delete Non-Running Workflow Runs

on:
  workflow_dispatch:   # run manually

jobs:
  clean:
    runs-on: ubuntu-latest

    steps:
      - name: Delete ONLY non-running workflow runs
        run: |
          TOKEN="${{ github.token }}"
          REPO="${{ github.repository }}"
          SELF="${{ github.run_id }}"

          echo "This workflow ID = $SELF"

          # Get all workflow runs
          RUNS=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/actions/runs" \
            | jq -c '.workflow_runs[] | {id: .id, status: .status}')

          for row in $RUNS; do
            ID=$(echo "$row" | jq -r '.id')
            STATUS=$(echo "$row" | jq -r '.status')

            # Skip active workflows and this workflow itself
            if [ "$STATUS" = "in_progress" ] || [ "$STATUS" = "queued" ] || [ "$ID" = "$SELF" ]; then
              echo "Skipping $ID (status: $STATUS)"
              continue
            fi

            echo "Deleting workflow run: $ID (status: $STATUS)"
            curl -X DELETE -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$REPO/actions/runs/$ID"
          done

      - name: Done
        run: echo "âœ” Deleted all non-running workflow runs"
