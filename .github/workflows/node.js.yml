name: Minecraft AFK Bot

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # restart every 6 hours

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Dependencies
        run: npm install

      - name: Run Bot Forever
        run: |
          while true; do
            npm start || true
            echo "Restarting bot..."
            sleep 3
          done

      - name: Delete ONLY non-running workflow runs
        if: always()
        run: |
          TOKEN="${{ github.token }}"
          REPO="${{ github.repository }}"
          SELF="${{ github.run_id }}"

          echo "This workflow ID = $SELF"

          # Get all workflow runs
          RUNS=$(curl -s -H "Authorization: token $TOKEN" \
            "https://api.github.com/repos/$REPO/actions/runs" \
            | jq -c '.workflow_runs[] | {id: .id, status: .status}')

          for row in $RUNS; do
            ID=$(echo "$row" | jq -r '.id')
            STATUS=$(echo "$row" | jq -r '.status')

            # Skip active workflows and this workflow itself
            if [ "$STATUS" = "in_progress" ] || [ "$STATUS" = "queued" ] || [ "$ID" = "$SELF" ]; then
              echo "Skipping $ID (status: $STATUS)"
              continue
            fi

            echo "Deleting workflow run: $ID (status: $STATUS)"
            curl -X DELETE -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$REPO/actions/runs/$ID"
          done
          
